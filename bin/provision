#!/bin/bash

source lib/common.sh

COMMANDS=()
declare -A COMMANDS_DESC
declare -A REGION_MAP

# Commands setup
COMMANDS+=("create")
COMMANDS+=("obscure")
COMMANDS+=("update")
COMMANDS+=("destroy")
COMMANDS+=("inventory")
COMMANDS+=("clobber")
COMMANDS+=("links")
COMMANDS+=("log")
COMMANDS+=("status")

COMMANDS_DESC["create"]="Create a new proxy instance and then obscure (au|usa|eu)"
COMMANDS_DESC["obscure"]="Obscure (change) ssh port and then update (au|usa|eu)"
COMMANDS_DESC["update"]="Complete provisioning (au|usa|eu)"
COMMANDS_DESC["destroy"]="Destroy an existing proxy instance"
COMMANDS_DESC["inventory"]="List all proxy instances"
COMMANDS_DESC["clobber"]="Remove virtualenv, temporary and log files"
COMMANDS_DESC["links"]="Show useful Linode API reference links"
COMMANDS_DESC["log"]="Show logs for instance"
COMMANDS_DESC["status"]="Show status of instances"

# Region mappings
REGION_MAP["au"]="ap-southeast"
REGION_MAP["usa"]="us-west"
REGION_MAP["eu"]="eu-west"

DEFAULT_TAIL_LINES=200

help_cmd() {
    echo "Usage: $(basename $0) <command> [options]"
    echo "Commands:"
    for cmd in "${COMMANDS[@]}"; do
        printf "  %-15s %s\n" "$cmd" "${COMMANDS_DESC[$cmd]}"
    done
}

create_cmd() {
    region="$1"
    shift
    run_playbook "$region" create "$@" &&
      echo "Sleeping 30s ..." &&
      sleep 30 &&
      obscure_cmd "$region" "$@"
}

obscure_cmd() {
    region="$1"
    shift
    export BOOT=1
    run_playbook "$region" obscure "$@" &&
      update_cmd "$region" "$@"
}

update_cmd() {
    region="$1"
    shift
    run_playbook "$region" update "$@" &&
      echo "Sleeping 150 seconds ..." &&
      sleep 150 &&
      status_cmd "$region" &&
      bin/test_proxy "$region"
}

run_playbook() {
    region="$1"
    playbook="$2"
    shift 2
    verify_region "$region" "$playbook"
    ensure_linode_token
    ensure_proxy_domain

    instance_name="${region}-proxy"
    linode_region=${REGION_MAP[$region]}
    extra_args=''
    if [ -n "$BOOT" ]; then
        extra_args='-e ansible_ssh_user=root -e ansible_ssh_port=22'
    fi

    echo "Running: ansible-playbook '$playbook.yml' -e 'instance_name=$instance_name' -e 'region=$linode_region' $extra_args $*"
    # shellcheck disable=SC2086
    time ansible-playbook "$playbook.yml" -e "instance_name=$instance_name" -e "region=$linode_region" $extra_args "$@"
}

destroy_cmd() {
    region="$1"
    shift
    verify_region "$region" destroy

    instance_name="${region}-proxy"
    ensure_linode_token
    echo "Running: ansible-playbook destroy.yml -e 'instance_name=$instance_name'"
    time ansible-playbook destroy.yml -e "instance_name=$instance_name" "$@"
}

inventory_cmd() {
  bin/inventory
}

clobber_cmd() {
    echo "Running bin/clobber"
    bin/clobber
}

links_cmd() {
    cat files/links.txt
}

status_cmd() {
    bin/status "$@"
}

log_cmd() {
    region="$1"
    verify_region "$region" log
    h="$region-proxy.$PROXY_DOMAIN"

    local tail_args="${*:--n $DEFAULT_TAIL_LINES}"
    # shellcheck disable=SC2029
    ssh "root@$h" "tail $tail_args /var/log/squid/access.log"
}

load_ports

command="$1"
case "$command" in
    ""|"-h"|"--help")
        help_cmd
        ;;
    *)
        shift
        valid_command=0
        for cmd in "${COMMANDS[@]}"; do
            if [[ "$command" == "$cmd" ]]; then
                valid_command=1
                break
            fi
        done

        if ((valid_command)); then
            if [ "$command" != clobber ]; then
                check_dependencies
            fi
            "${command}_cmd" "$@"
        else
            echo "Unknown command: $command"
            help_cmd
            exit 1
        fi
        ;;
esac

